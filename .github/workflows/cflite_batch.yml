name: ClusterFuzzLite batch fuzzing
on:
  # For testing: trigger on push to feat/fuzz branch
  push:
    branches:
      - feat/fuzz
  schedule:
    # Run every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      fuzz-seconds:
        description: 'Fuzzing duration in 60 seconds'
        required: false
        default: '60'
        type: string

permissions: read-all

# ==============================================================================
# Storage Repository Configuration for Organization
# ==============================================================================
# Required secrets/variables:
#   - Secret: CLUSTERFUZZLITE_STORAGE_TOKEN (PAT with repo write access)
#   - Variable: CLUSTERFUZZLITE_STORAGE_REPO (e.g., morph-l2/fuzz_corpora)
#
# Note: GitHub Actions has a 6-hour job time limit.
# ClusterFuzzLite will automatically run all compiled fuzzers in round-robin.
# ==============================================================================

env:
  STORAGE_REPO_URL: ${{ secrets.CLUSTERFUZZLITE_STORAGE_TOKEN && vars.CLUSTERFUZZLITE_STORAGE_REPO && format('https://{0}@github.com/{1}.git', secrets.CLUSTERFUZZLITE_STORAGE_TOKEN, vars.CLUSTERFUZZLITE_STORAGE_REPO) || '' }}
  STORAGE_REPO_BRANCH: main
  # push: 120s (2min), schedule: 120s (2min), manual: use input
  FUZZ_SECONDS: ${{ github.event_name == 'push' && '120' || github.event_name == 'schedule' && '120' || inputs.fuzz-seconds || '19800' }}

jobs:
  BatchFuzzing:
    runs-on: ubuntu-latest
    steps:
      - name: Build Fuzzers
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: go
          github-token: ${{ secrets.GITHUB_TOKEN }}
          sanitizer: address
          # Keep all fuzzers on push (disable incremental analysis for testing)
          keep-unaffected-fuzz-targets: ${{ github.event_name == 'push' }}
          storage-repo: ${{ github.event_name != 'push' && env.STORAGE_REPO_URL || '' }}
          storage-repo-branch: ${{ env.STORAGE_REPO_BRANCH }}

      - name: Run Fuzzers
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fuzz-seconds: ${{ env.FUZZ_SECONDS }}
          mode: 'batch'
          sanitizer: address
          output-sarif: true
          parallel-fuzzing: true
          # Don't pass storage-repo on push to disable incremental analysis
          storage-repo: ${{ github.event_name != 'push' && env.STORAGE_REPO_URL || '' }}
          storage-repo-branch: ${{ env.STORAGE_REPO_BRANCH }}

      - name: Upload Crash
        uses: actions/upload-artifact@v4
        if: failure() && steps.run.outcome == 'failure'
        with:
          name: crash-artifacts
          path: ./out/artifacts
          retention-days: 90

      - name: Debug - List output files
        if: always()
        run: |
          echo "=== Listing ./out directory ==="
          find ./out -type f 2>/dev/null || echo "No ./out directory found"
          echo ""
          echo "=== Looking for SARIF files ==="
          find . -name "*.sarif" 2>/dev/null || echo "No SARIF files found"

      - name: Check SARIF file exists
        id: sarif-check
        if: always() && steps.run.outcome != 'skipped'
        run: |
          if [ -f "./out/sarif/results.sarif" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No SARIF file generated (no crashes found)"
          fi

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.sarif-check.outputs.exists == 'true'
        with:
          sarif_file: ./out/sarif/results.sarif
          checkout_path: ./out/sarif
        continue-on-error: true
